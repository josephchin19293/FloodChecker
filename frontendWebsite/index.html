<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <script src='global.js'></script>
        <!-- Chartist links-->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.0/chartist.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.0/chartist.js"></script>
        <title>Home</title>
    </head>
    <body>
        <div w3-include-html="header.html"></div>
        <div class='container' style='margin-top: 80px;margin-bottom: 90px'>
            <div class='jumbotron'>
                <h1 class="display-d">Data visualisation</h1>
            </div>
            
        
        <div id="map" style="width:100%;height:650px"></div>
        <div class="ct-chart ct-perfect-fourth"></div>
        
    <script>
      var map;  
      var jsonData;
      var currentSensorOpen = null;
      var markers = [];
      var currentMarker;
      var infowindow;
      var timer;
      function initMap() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if(this.readyState == 4 && this.status == 200) {
                jsonData = JSON.parse(xhttp.responseText);
                //Create map
                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: jsonData.mapCenter.lat, lng: jsonData.mapCenter.long},
                    zoom: 16
                });
                //Create markers
                infowindow = new google.maps.InfoWindow();
                var marker;
                for(var i = 0; i < jsonData.mostRecentReadings.length; i++) {
                    marker = new google.maps.Marker({
                        position: new google.maps.LatLng(parseFloat(jsonData.mostRecentReadings[i].latitude),parseFloat(jsonData.mostRecentReadings[i].longitude)),
                        map: map,
                        title: jsonData.mostRecentReadings[i].sensor,
                        json:jsonData.mostRecentReadings[i]
                    });
                    
                    google.maps.event.addListener(infowindow,'closeclick',function(){
                        currentMarker = null; //removes the marker
                        // then, remove the infowindows name from the array
}                   );
                    google.maps.event.addListener(marker, 'click', function(){
                        currentSensorOpen = this.json.sensor;
                        currentMarker = this;
                        infowindow.close(); // Close previously opened infowindow
                        infowindow.setContent("<h6>"+this.json.sensor+"</h6><p>Reading : "+this.json.value+"mm<br>Timestamp : "+this.json.timestamp+"</p>");
                        infowindow.open(map, this);
                        updateGraphData();
                    });

                    markers.push(marker);
                    
                }
                //Create timer
                timer = setInterval(updateData,300000);
                //Create graph
                createGraphData();
            }
        };
        xhttp.open("GET","initMap.php",true);
        xhttp.send();
        
      }
      function updateData() {
          var xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
            if(this.readyState == 4 && this.status == 200) {
                jsonData = JSON.parse(xhttp.responseText);
                //Update markers
                for(var i = 0; i < markers.length;i++) {
                    for(var j =0; j < jsonData.mostRecentReadings.length;j++) {
                        if(markers[i].json.sensor == jsonData.mostRecentReadings[j].sensor) {
                            markers[i].json = jsonData.mostRecentReadings[j];
                        }
                    }   
                }
                //Refresh current window
                if(currentMarker != null) {
                    infowindow.close();
                    infowindow.setContent("<h6>"+currentMarker.json.sensor+"</h6><p>Reading : "+currentMarker.json.value+"mm<br>Timestamp : "+currentMarker.json.timestamp+"</p>");
                    infowindow.open(map, currentMarker);
                }
                updateGraphData();
            }
          };
          xhttp.open("GET","initMap.php",true);
          xhttp.send();
      }
      var options = {
            height:300,
            scaleMinSpace: 20,
            showArea:true,
            axisX: {
                labelInterpolationFnc: function(value, index) {
                    return index % (24*4) === 0 ? new Date(value).toDateString() : null;
                }}
        }
      function createGraphData() {
        var labelArray = [];
        var seriesArray = []; 
        for(var i =0; i<jsonData.allReadings[0].readings.length;i++) {
            labelArray.push(jsonData.allReadings[0].readings[i].timestamp);
            seriesArray.push(jsonData.allReadings[0].readings[i].value);
        }
        console.log(labelArray);
        console.log(seriesArray);
        var seriesTwo = [];
        seriesTwo.push(seriesArray);
        var data = {
            labels:labelArray,
            series:seriesTwo
        }
        new Chartist.Line('.ct-chart', data,options);
      }
      function updateGraphData() {
        var labelArray = [];
        var seriesArray = []; 
        var sensorReadings;
        if(currentSensorOpen == null) {
            sensorReadings = jsonData.allReadings[0];
        } else {
            for(var i =0; i< jsonData.allReadings.length;i++) {
                console.log(currentSensorOpen);
                if(jsonData.allReadings[i].sensor == currentSensorOpen) {
                    sensorReadings = jsonData.allReadings[i];
                }
            }
        }
        for(var i =0; i<sensorReadings.readings.length;i++) {
            labelArray.push(sensorReadings.readings[i].timestamp);
            seriesArray.push(sensorReadings.readings[i].value);
        }
        console.log(labelArray);
        console.log(seriesArray);
        var seriesTwo = [];
        seriesTwo.push(seriesArray);
        var data = {
            labels:labelArray,
            series:seriesTwo
        }
        new Chartist.Line('.ct-chart', data,options);
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjRSg_67zXcr-nx8uNPjvFgecVFj2ahxI&callback=initMap"
    async defer></script>
</div>
        <script>
            includeHTML();
        </script>
        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    </body>
</html>
